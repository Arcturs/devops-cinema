- name: Create metrics-server directory
  become: yes
  file:
    path: /tmp/metrics-server
    state: directory

- name: Download metrics-server manifest
  get_url:
    url: "https://github.com/kubernetes-sigs/metrics-server/releases/{{ metrics_server_version }}/download/components.yaml"
    dest: /tmp/metrics-server/components.yaml

- name: Patch metrics-server for self-signed certs
  lineinfile:
    path: /tmp/metrics-server/components.yaml
    regexp: '^(\s*)--kubelet-insecure-tls'
    line: '\1- --kubelet-insecure-tls'
    insertafter: '^\s*- --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname'
  when: ansible_os_family == 'Ubuntu'

- name: Apply metrics-server
  command: kubectl apply -f /tmp/metrics-server/components.yaml